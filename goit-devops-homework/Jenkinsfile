pipeline {
    agent {
        kubernetes {
            yaml '''
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:debug
    command:
    - cat
    tty: true
  - name: git-tools
    image: bitnami/git:latest
    command:
    - cat
    tty: true
  - name: python
    image: python:3.9-slim
    command:
    - cat
    tty: true
'''
        }
    }
    
    environment {
        ECR_REGISTRY = '842303507369.dkr.ecr.eu-west-1.amazonaws.com/lesson-8-9-django-repo' 
        GITHUB_REPO  = 'github.com/oksanaliu/goit-devops-homework.git'
        IMAGE_NAME   = 'django-app'
        TAG          = "${env.BUILD_NUMBER}"
    }

    stages {
        stage('CI: Test, Lint & Security') {
            steps {
                container('python') {
                    sh '''
                    echo "--- Installing Test Dependencies ---"
                    pip install --quiet --upgrade pip
                    pip install --quiet pytest pylint bandit

                    echo "--- Running Pylint (Linting) ---"
                    find . -name "*.py" | xargs pylint --fail-under=5 || true

                    echo "--- Running Bandit (Security Scan) ---"
                    bandit -r . || true

                    echo "--- Running Pytest (Unit Tests) ---"
                    pytest || true
                    '''
                }
            }
        }

        stage('Build & Push to ECR') {
            steps {
                container('kaniko') {
                    withCredentials([usernamePassword(credentialsId: 'aws-creds', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                        sh '''
                        DOCKERFILE_PATH=$(find . -name Dockerfile | head -n 1)
                        CONTEXT_DIR=$(dirname $DOCKERFILE_PATH)
                        
                        /kaniko/executor --context $CONTEXT_DIR \
                        --dockerfile $DOCKERFILE_PATH \
                        --destination $ECR_REGISTRY:$TAG \
                        --force
                        '''
                    }
                }
            }
        }

        stage('Update Helm Chart') {
            steps {
                container('git-tools') {
                    withCredentials([usernamePassword(credentialsId: 'github-creds', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_TOKEN')]) {
                        sh '''
                        git config --global --add safe.directory ${WORKSPACE}
                        git config --global user.email "jenkins@example.com"
                        git config --global user.name "Jenkins Bot"

                        sed -i "s/tag: .*/tag: \\"$TAG\\"/" lesson-8-9/charts/django-app/values.yaml

                        git remote set-url origin https://${GIT_USER}:${GIT_TOKEN}@${GITHUB_REPO}
                        
                        if git status --porcelain | grep -q "lesson-8-9/charts/django-app/values.yaml"; then
                            git add lesson-8-9/charts/django-app/values.yaml
                            git commit -m "Update image tag to $TAG [skip ci]"
                            git push origin HEAD:lesson-8-9
                        else
                            echo "No changes to commit"
                        fi
                        '''
                    }
                }
            }
        }
    }
}


