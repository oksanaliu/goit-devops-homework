pipeline {
    agent {
        kubernetes {
            yaml '''
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:debug
    command:
    - cat
    tty: true
  - name: git-tools
    image: bitnami/git:latest
    command:
    - cat
    tty: true
'''
        }
    }
    
    environment {
        ECR_REGISTRY = '842303507369.dkr.ecr.eu-west-1.amazonaws.com/lesson-8-9-django-repo' 
        GITHUB_REPO  = 'github.com/oksanaliu/goit-devops-homework.git'
        IMAGE_NAME   = 'django-app'
        TAG          = "${env.BUILD_NUMBER}"
    }

    stages {

        stage('Build & Push to ECR') {
            steps {
                container('kaniko') {
                    withCredentials([usernamePassword(credentialsId: 'aws-creds', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                        sh '''
                        # Шукаємо, де саме лежить Dockerfile, щоб не вгадувати
                        DOCKERFILE_PATH=$(find . -name Dockerfile | head -n 1)
                        CONTEXT_DIR=$(dirname $DOCKERFILE_PATH)
                        
                        /kaniko/executor --context $CONTEXT_DIR \
                        --dockerfile $DOCKERFILE_PATH \
                        --destination $ECR_REGISTRY:$TAG \
                        --force
                        '''
                    }
                }
            }
        }

             stage('Update Helm Chart') {
            steps {
                container('git-tools') {
                    withCredentials([usernamePassword(credentialsId: 'git-creds', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_TOKEN')]) {
                        sh '''
                        # Виправляємо помилку безпеки Git
                        git config --global --add safe.directory ${WORKSPACE}
                        
                        git config --global user.email "jenkins@example.com"
                        git config --global user.name "Jenkins Bot"
                        
                        # Оновлюємо тег (переконайся, що шлях правильний)
                        # Якщо файл лежить у django-app/values.yaml, то шлях має бути таким:
                        sed -i "s/tag: .*/tag: \"$TAG\"/" django/charts/django-app/values.yaml
                        
                        git remote set-url origin https://$GIT_USER:$GIT_TOKEN@$GITHUB_REPO
                        git add .
                        git commit -m "Update image tag to $TAG [skip ci]"
                        git push origin lesson-8-9
                        '''
                    }
                }
            }
        }

    }
}
